**总结：**
- 如果不能接受数据丢失，使用AOF的`appendfsync always`，为了加快恢复，可以使用混合模式。rdb快照备份 + aof增量。
- 如果可以允许部分的数据丢失，可以只使用rdb。
- 也可以只使用aof模式，`appendfsync everysec`。可以有短暂的数据丢失。

**优化方式：**
- RDB：
	- bgsave：开启子进程同步。不阻塞主进程处理请求数据。
	- Copy On Write：在同步时候修改的数据放入缓冲区，子进程同步这个缓冲区数据。这样不会阻塞也会尽可能保证数据一致性。
- AOF：
	- 日志重写：对过大的AOF日志重写（对当前数据库值进行备份生成新文件，并不是操作之前的AOF文件），减小日志大小。
	- AOF缓冲区：主进行在aof重写时，既操作原来的AOF，还会写入缓冲区，这样保证了重写时主进程还能处理请求，并且持久化失败也不影响AOF日志恢复。

## 1. Redis持久化方式

- RDB（Redis Database）：每间隔指定时间对数据进行快照存储。
- AOF（Append Only File）：记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据。

## 2. RDB

redis在执行写操作的时候，内存会一直变化，内存快照就是记录这一时刻内存数据，想当于拍照时候按下快门拍下照片。Redis将这一时刻的内存数据持久化到磁盘当中，这个快照文件就是rdb文件。这样我们就不需要每次写操作都进行备份了，提升了性能。

![image](https://raw.githubusercontent.com/future94/java-technology/master/cache/redis/images/dsajuikn12312321.png)


**rdb生成策略：**
- **save** ：主线程执行，会阻塞。不推荐使用。
- **bgsave** ：调用 glibc 的函数fork产生一个子进程用于写入 RDB 文件，快照持久化完全交给子进程来处理，父进程继续处理客户端请求，生成 RDB 文件的默认配置。

**生成rdb文件时如何保证主进程与子进程数据一致性？**

采用 `写时复制技术`（Copy On Write）保证数据一致性。这样在生成rdb快照时，主进程也可以修改数据。

当我们触发生成RDB文件时，redis会fork一个子进程来进行该操作，bgsave 子进程在创建之初可以共享主进程的所有内存数据，读取主线程的数据并写入到 RDB 文件。当主进程修改内存时，如果有线程正在进程rdb操作，那么就会复制一份数据副本，子进程可以读取这个数据副本。

**优缺点：**

优点：
- RDB 采用二进制 + 数据压缩的方式写磁盘，文件体积小，快照的恢复速度很快，读取快照内容就能恢复数据。
- 适合做容灾数据备份。

缺点：
- 生成快照的时候间隔不好把握，太低可能导致数据丢失过多，太快会影响性能导致上次还没持久化下次备份有开始了。
- 主进程fork子进程的时候会阻塞请求。

**配置：**
```conf
#在900秒(15分钟)之后，如果至少有1个key发生变化，则dump内存快照。
save 900 1
#在300秒(5分钟)之后，如果至少有10个key发生变化，则dump内存快照。
save 300 10
#在60秒(1分钟)之后，如果至少有10000个key发生变化，则dump内存快照。
save 60 10000
```

## 3. AOF

AOF顺序的记录了redis写操作。当要恢复时候，我们可以通过按顺序执行这些命令，就可以对数据进行恢复。类似与MySQL的binlog，其中就顺序的记录了sql执行命令。

**写前日志和写后日志区别：**
- 写前日志：先写入日志，再执行命令操作。先写日志在执行命令，会对当前命令执行阻塞，还需要检查语法的正确性，避免日志中记录了错误的操作。MySQL的redo log就是之后的写前日志的方式。写前日志的好处是如果执行命令时候挂了，也可以恢复，写后日志如果命令执行还没来的及写入，那么这时候数据就丢失了。
- 写后日志：先执行命令操作，再写入日志。不会对当前命令执行产生阻塞，也不需要对命令语法进行检测。但是虽然不会对当前命令产生阻塞，但也可能会对下条命令产生阻塞，所以redis才用 `回写机制` 。

**redis写后日志的回写机制：**
redis才用写后日志，刚才说了可能对下条命令产生阻塞，所以redis用回写机制解决这个问题。redis会先将写入数据暂时保存在一个内存缓冲区里面，等到缓冲区的空间被填满、或者超过了指定的时限之后，才真正地将缓冲区中的数据写入到磁盘里面。

为此，系统提供了`fsync`和`fdatasync`两个同步函数，它们可以强制让操作系统立即将缓冲区中的数据写入到硬盘里面，从而确保写入数据的安全性。

**redis回写策略配置：**
Redis 提供的 AOF 配置项appendfsync写回策略直接决定 AOF 持久化功能的效率和安全性。

```conf
#每次有数据修改发生时都会写入AOF文件。
appendfsync always
#每秒钟同步一次，该策略为AOF的缺省策略。
appendfsync everysec
#由系统控制，我们不管了。高效但是数据不会被持久化。
appendfsync no
```
- always：同步写回，写指令执行完毕立马将 aof_buf缓冲区中的内容刷写到 AOF 文件。
- everysec：每秒写回，写指令执行完，日志只会写到 AOF 文件缓冲区，每隔一秒就把缓冲区内容同步到磁盘。
- no： 操作系统控制，写执行执行完毕，把日志写到 AOF 文件内存缓冲区，由操作系统决定何时刷写到磁盘。

**AOF日志格式：**
当 Redis 接受到 `set key value`命令将数据写到内存后，Redis 会按照如下格式写入 AOF 文件。

```txt
*3
$3
set
$3
key
$5
value
```

- `*3`：代表了这个命令由3部分组成。
- `$3`、`$5`：代表了这个部分占用多少个字节。

**AOF 重写机制：**
随着redis运行，AOF日志会越来越大，所以redis提供了 `bgrewriteaof` 指令来对aof日志进行瘦身。原理如下：
```shell
// 运行了四条命令
RPUSH list 1 2 3 4      // [1, 2, 3, 4]

RPOP list               // [1, 2, 3]

LPOP list               // [2, 3]

LPUSH list 1            // [1, 2, 3]
// 实际上只需要一条命令即可恢复
RPUSH 1 2 3 
```

重写过程是由子进程来完成的，不会阻塞主进程。主进程在AOF重写时也可以进行写操作，如果主进程进行写操作日，redis将数据写入旧的AOF缓冲区和新的AOF重写缓冲区。<font color="red">重写是一个有歧义的名字，是根据数据库当前值进行的，不会读、写原来的AOF文件</font>。

当子进程在执行 AOF 重写时， 主进程需要执行以下三个工作：

1. 处理命令请求。
2. 将写命令追加到现有的 AOF 缓存区中。
3. 将写命令追加到 AOF 重写缓存中。

这样一来可以保证：

1. 现有的 AOF 功能会继续执行，即使在 AOF 重写期间发生停机，也不会有任何数据丢失。
2. 所有对数据库进行修改的命令都会被记录到 AOF 重写缓存中。

当子进程完成 AOF 重写之后， 它会向父进程发送一个完成信号， 父进程在接到完成信号之后， 会调用一个信号处理函数， 并完成以下工作：

1. 将 AOF 重写缓存中的内容全部写入到新 AOF 文件中。
2. 对新的 AOF 文件进行改名，覆盖原有的 AOF 文件。

![image](https://raw.githubusercontent.com/future94/java-technology/master/cache/redis/images/d87yi123kljdsa98j.png)

**优点：**
- 可以有效减小AOF日志的体积。
- 即使执行失败也不影响原来的AOF日志。
- 写入新日志不会和主进程原来的操作日志产生竞争。

**缺点：**
- 记录的是命令，当没有重做的时候，日志过大时恢复比rdb慢很多。
- 记录频率问题，每次都从缓冲区刷新到磁盘性能比较低，每秒中执行的话还是会损失一秒的数据。

## 4. 混合模式

重启 Redis 时，我们很少使用 rdb 来恢复内存状态，因为会丢失大量数据。我们通常使用 AOF 日志重放，但是重放 AOF 日志性能相对 rdb 来说要慢很多，这样在 Redis 实例很大的情况下，启动需要花费很长的时间。

所以redis4.0+可以实现`混合持久化`。将RDB和AOF共同使用，RDB记录某个时刻的数据快照，而AOF记录RDB持久化这个时刻到下次持久化时候的操作记录，这样启动时我们可以先执行RDB恢复，在执行这一时间段的AOF日志就可以快速的恢复。

所以 RDB 内存快照以稍微慢一点的频率执行，在两次 RDB 快照期间使用 AOF 日志记录期间发生的所有「写」操作。

这样快照就不用频繁的执行，同时由于 AOF 只需要记录两次快照之间发生的「写」指令，不需要记录所有的操作，避免出现文件过大的情况。


参考文章：
- [Redis AOF原理](https://blog.csdn.net/luolaifa000/article/details/84178289)
- [Redis 日志篇：无畏宕机快速恢复的杀手锏](https://mp.weixin.qq.com/s/vpuMsen_s5Ye3Giz-59C3w)
