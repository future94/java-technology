
## 1. 关键点

- 迁移之后要保证每条数据不丢失而且正确
- 不影响用户正常使用（不需要长时间停机等待）
- 迁移之后数据的稳定运行

## 2. 方案

挂从库、双写、数据同步工具

### 2.1 挂从库

以MySQL为例子，可以在MySQL Master库上加一个Slave库同步主库数据，数据同步完成之后再将Slave库变成Master库，再将数据访问切到新的Master库上。

**具体步骤** ：  
1. 从主库中同步数据。
2. 数据同步完成之后，为了保证数据的完整性允许停机几分钟做数据库切换。
3. 迁移完成。

**优缺点** ：  
简单快捷，适用于表结构没有变化的，允许短暂空闲时间停机迁移的场景。

### 2.2 双写

在对数据库需要增删改的地方都要进行代码修改，保证新库和老库都会生效，运行同步脚本同步之前的老数据，运行检查脚本校验同步是否有错误或者遗漏，热开关新库老库的切换（或者灰度发布，先切一点流量到新库，稳定在全部切换）。

**具体步骤** ：  
1. 代码编写，对数据库需要增删改的地方都要进行代码修改，上线开启双写。（更新操作如果没有，可以先从老数据库同步过来在更新；如果为了性能，可以新库可以采用异步的心形式）
2. 执行代码同步脚本同步之前数据，注意同步时间点，避免溜掉数据。
3. 运行校验代码，校验同步是否有错误或者遗漏。
4. 热开关新库老库的切换（或者灰度发布，先切一点流量到新库，稳定在全部切换）。
5. 后续上线时候可以删掉之前无用的代码。

**优缺点** ：  
不需要停机，可以应对数据库结构有变化的场景，缺点十分明显，代码入侵严重。

### 2.3 挂从库、双写、数据同步工具
如果我们不想停机，而且也不想先有项目代码高入侵，我们可以在双写的基础上使用同步工具对迁移以后的新数据进行同步。如Canal等。

**具体步骤** ：  
1. 准备Canal代码，解析Binlog，完成上线时新数据的同步。
2. 执行代码同步脚本同步之前数据，注意同步时间点，避免溜掉数据。
3. 运行校验代码，校验同步是否有错误或者遗漏。
4. 热开关新库老库的切换（或者灰度发布，先切一点流量到新库，稳定在全部切换）。
5. 停掉Canal。


参考文章：
- [每日百万订单，这样的技术方案更靠谱](https://mp.weixin.qq.com/s/_7jJNNPI21uPhWM2F7vapA)
